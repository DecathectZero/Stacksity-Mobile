<!DOCTYPE html>
<html lang="en">
<head>
    <title>Stacksity | Topstack</title>
    <meta name="format-detection" content="telephone=no" />
    <meta name="msapplication-tap-highlight" content="no" />
    <!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <link rel="stylesheet" href="css/jquerymobile.css">
    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/bootstraptheme.css">
    <link rel="stylesheet" href="css/style.css">
    <script type="text/javascript" charset="utf-8" src="cordova.js"></script>
    <script src="js/jquery.js"></script>
    <script type="text/javascript">
        document.addEventListener("deviceready", onDeviceReady, false);
        // device APIs are available
        //
        function onDeviceReady() {
            StatusBar.overlaysWebView(false);
            StatusBar.backgroundColorByHexString("#1c5380");
            StatusBar.styleLightContent();
        }

    </script>
    <script src="js/bootstrap.js"></script>
    <script src="js/autogrow.js"></script>
    <script src="js/output.js"></script>
    <script src="js/jquerymobile.js"></script>
<body>
<div data-role="page">
    <script src="js/vote.js"></script>
    <script src="js/main.js"></script>
    <script src="js/checklogin.js"></script>
    <script>
    /**
     * Created by killswitch on 4/18/2015.
     */
//var self = $('#selfid').html();
//var stackname = $('#stackname').val();
//var stackid = $('#stack').val();
//var post = false;
    imagepostShow();
    /*name();
     function name(){if(stackid == 0){
     $("#posting").html(self);
     }else{
     $("#posting").html(stackname);
     }
     }*/
    function linkpost(){
        $('#imagepost').hide();
        $('#textpost').hide();
        $('#linkpost').show();
        $("#link").prop('required',true);
        $("#image").prop('required',false);
        $("#text").prop('required',false);
        $('#posttype').val("0");
        $('#postimage').removeClass('active');
        $('#posttext').removeClass('active');
        $('#postlink').addClass('active');
    }
    function textpost(){
        $('#linkpost').hide();
        $('#imagepost').hide();
        $('#textpost').show();
        $("#text").prop('required',true);
        $("#image").prop('required',false);
        $("#link").prop('required',false);
        $('#posttype').val("1");
        $('#postimage').removeClass('active');
        $('#posttext').addClass('active');
        $('#postlink').removeClass('active');
        $("#text").expanding();
    }
    function imagepostShow(){
        $('#linkpost').hide();
        $('#textpost').hide();
        $('#imagepost').show();
        $("#text").prop('required', false);
        $("#image").prop('required', true);
        $("#link").prop('required', true);
        $('#posttype').val("0");
        $('#posttext').removeClass('active');
        $('#postimage').addClass('active');
        $('#postlink').removeClass('active');
    }
    $( "#title-input" ).keyup(function() {
        var length = $( this ).val().length;
        $( "#title-count").html(100-length);
    });

    var stackid = localStorage.getItem('stack');
    if(stackid == '0'){
        $('#topstack').addClass('active');
    }
    var post = false;
    var posting = false;
    var end = false;
    var bottom = false;
    var startnews = 0;
    var id = window.localStorage.getItem('session_id');

    function checkEnd(postnum){
        if(postnum == 0){
            end = true;
            $('.scroll').html('<p>No more posts</p>');
        }
    }
    startNews(startnews);
    function startNews(startnum) {
        if(end){
            return;
        }
        var postnum = 0;
        $.getJSON('http://stacksity.com/php/feed.php', {id : stackid , start : startnum , session_id: id }, function(data) {
            if(null==data){
                checkEnd(postnum);
            }else{
                $.each(data, function(index, element) {
                    if(element.posttype == 0){
                        $('.feed').append(linkspost(element));
                    }else if(element.posttype == 1){
                        $('.feed').append(textspost(element));
                    }else if(element.posttype == 2){
                        $('.feed').append(imagepost(element));
                    }else if(element.posttype == 3){
                        $('.feed').append(videopost(element));
                    }
                    postnum++;
                });
                bottom = false;
                checkEnd(postnum);
            }
        });
        startnews = startnews + 10;
        return true;
    }
    $(window).scroll(function() {
        if($(window).scrollTop() + $(window).height() > $("#content").height() - 200) {
            if(!end&&!bottom){
                bottom = true;
                $('.scroll').html('<p>Loading Posts</p> <div class="loader" style="top: -35px">Loading...</div>');
                startNews(startnews);
            }
        }
    });
    $("#toppost").on('submit', function(e){
        e.preventDefault();
        if(!posting){
            var data = $(this).serialize()+"&stack="+stackid+"&session_id="+id;
            posting = true;
            $('.postb').html('<div class="loader">Loading...</div>');
            e.preventDefault();
            $.ajax({
                type     : "POST",
                cache    : false,
                url      : 'http://stacksity.com/php/post.php',
                crossDomain : true,
                data     : data,
                success  : function(data) {
                    if(data.length<=2) {
                        if(data!=3){
                            alert("error :" + data);
                        }
                    }else{
                        $('.background-image').hide();
                        $('#toppost').trigger("reset");
                        $( "#title-count").html("100");
                        var element = $.parseJSON(data);
                        if(element.posttype == 0){
                            $(linkspost(element)).hide().prependTo('#feed').fadeIn("slow");
                        }else if(element.posttype == 1){
                            $('#text').val('').change();
                            $(textspost(element)).hide().prependTo('#feed').fadeIn("slow");
                        }else if(element.posttype == 2){
                            $(imagepost(element)).hide().prependTo('#feed').fadeIn("slow");
                        }else if(element.posttype == 3){
                            $(videopost(element)).hide().prependTo('#feed').fadeIn("slow");
                        }
                    }
                    $('.postb').html('Post');
                    $('#private').html('Private');
                    $('#privatefield').val(0);
                    posting = false;
                },
                error: function(xhr, status, error) {
                    alert("error"+ xhr.responseText);
                    $('.postb').html('Post');
                    $('#private').html('Private');
                    posting = false;
                }
            });
        }else{
            e.preventDefault();
        }
    });
    $( ".follow" ).click(function() {
        if($(this).val()==1){
            $(this).val(0);
            $(this).removeClass('followed');
            $(this).html('Follow');
            $("#followers").html(parseInt($("#followers").html())-1);
        }else{
            $(this).addClass('followed');
            $(this).html('Followed');
            $(this).val(1);
            $("#followers").html(parseInt($("#followers").html())+1);
        }
        $.ajax({
            type     : "POST",
            cache    : false,
            url      : 'php/follow.php',
            data     : { stack: stackid, session_id: id},
            success: function(data){
            },
            error: function(xhr, status, error) {
                alert("error"+ xhr.responseText);
            }
        });
    });
    /* Drag'n drop stuff */
    function upload(file) {
        /* Is the file an image? */
        if (!file || !file.type.match(/image.*/)) return;
        /* It is! */
        document.body.className = "uploading";
        $('#imageid').val("uploading...");
        /* Lets build a FormData object*/
        var fd = new FormData(); // I wrote about it: https://hacks.mozilla.org/2011/01/how-to-develop-a-html5-image-uploader/
        fd.append("image", file); // Append the file
        var xhr = new XMLHttpRequest(); // Create the XHR (Cross-Domain XHR FTW!!!) Thank you sooooo much imgur.com
        xhr.open("POST", "https://api.imgur.com/3/image.json"); // Boooom!
        xhr.onload = function() {
            // Big win!
            var link = JSON.parse(xhr.responseText).data.link;
            $('#link').val(link);
            $('#imageid').val(file.name);
            $('#imagePostPreview').attr('src', link);
            $('.background-image').show();
            document.body.className = "uploaded";
        }

        xhr.setRequestHeader('Authorization', 'Client-ID 2caf3e86e092d76'); // Get your own key http://api.imgur.com/

        // Ok, I don't handle the errors. An exercise for the reader.
        /* And now, we send the formdata */
        xhr.send(fd);
    }
    function stackTrace() {
        var err = new Error();
        return err.stack;
    }
    </script>
    <div class="footer">
        <div class="center botmenu">
            <a class="stacklink" data-link="0">
                <div class="quarter" id="topstack">
                    <div class="glyphicon glyphicon glyphicon-home"></div>
                </div>
            </a>
            <a class="stacklink" href="index.html" data-link="0">
                <div class="quarter" id="allstack">
                    <div class="glyphicon glyphicon glyphicon-th-list"></div>
                </div>
            </a>
            <a class="stacklink" href="stack.html" data-link="0">
                <div class="quarter">
                    <div class="glyphicon glyphicon glyphicon-bell"></div>
                </div>
            </a>
            <a class="stacklink" href="stack.html" data-link="0">
                <div class="quarter">
                    <div class="glyphicon glyphicon glyphicon-search"></div>
                </div>
            </a>
            <a class="stacklink" href="stack.html" data-link="0">
                <div class="quarter">
                    <div class="glyphicon glyphicon glyphicon-user"></div>
                </div>
            </a>
        </div>
    </div>
    <div id="content" data-role="main">
            <div class="banner topbanner center">
                <div class="center banner-inner">
                    <div class="bannertext"><h1>topstack</h1>
                        <p>Your frontpage of stacks</p></div> </div>
            </div>
            <div class="center post">
                <div class="row postrow posting">
                    <a class="col-xs-4" onclick="linkpost()" id="postlink">Link</a>
                    <a class="col-xs-4" onclick="textpost()" id="posttext">Text</a>
                    <a class="col-xs-4 active" onclick="imagepostShow()" id="postimage">Image</a>
                </div>
                <form class="postform" id="toppost">
                    <input type="hidden" id="posttype" name="type" value="0">
                    <input type="hidden" name="user_value" value="1">
                    <div class="postcon">
                        <p>title <span id="title-count">100</span></p>
                        <input name="title" type="text" id="title-input" class="texts" placeholder="post title" maxlength="100" required="" data-role="none">
                        <div id="linkpost" style="display: none;">
                            <p>link <span id="link-alert"></span></p>
                            <input name="link" type="url" id="link" class="texts" placeholder="submit a link here" maxlength="500" required="" data-role="none">
                        </div>
                        <div id="textpost" style="display: none;">
                            <p>text</p>
                            <textarea name="text" class="expanding" id="text" placeholder="Write something here..." rows="2" maxlength="6500" data-role="none"></textarea>
                        </div>
                        <div id="imagepost">
                            <p>image</p>
                            <div class="input-group">
                <span class="input-group-btn">
                <span class="btn btn-primary btn-file" id="uploadimage">
                <span class="glyphicon glyphicon-camera" ></span> Photo <input type="file" accept="image/x-png, image/gif, image/jpeg" onchange="upload(this.files[0])" data-role="none">
                </span>
                </span>
                                <input type="text" id="imageid" class="form-control" readonly="" data-role="none">
                            </div>
                            <div class="background-image"><img src="" id="imagePostPreview" class="img-responsive"></div>
                        </div>
                    </div>
                    <div class="postsub">
                        <input type="hidden" name="setprivate" value="0" id="privatefield">
                        <button type="submit" class="postb" data-role="none">Post</button>
                        <button type="button" id="private" class="postb private" data-role="none">Private</button>
                    </div>
                    <label class="postlabel">
                        posting to <span class="bold" id="posting">karthus</span>
                    </label>
                </form>
            </div>
            <div class="center feed" id="feed">
            </div>
            <div class="scroll center">
                <div class="loader">Loading...</div>
            </div>
            <div class="botgap"></div>
    </div>
    <div class="modal fade" id="delpost">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-body">
                    <p>Are you sure you want to delete this post?</p>
                </div>
                <div class="modal-footer">
                    <a id="deletelink" class="btn btn-primary">Delete</a>
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>